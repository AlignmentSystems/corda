FROM azul/zulu-openjdk-alpine:8u192

RUN apk update && apk upgrade && apk add bash curl unzip

# Create corda user
RUN addgroup corda && \
    adduser corda -G corda -D -s bash -h /opt/corda

RUN mkdir -p /opt/corda/cordapps && \
    mkdir -p /opt/corda/persistence && \
    mkdir -p /opt/corda/certificates && \
    mkdir -p /opt/corda/drivers && \
    mkdir -p /opt/corda/logs && \
    mkdir -p /opt/corda/bin && \
    mkdir -p /opt/corda/additional-node-infos && \
    mkdir -p /etc/corda

WORKDIR /opt/corda

ENV CORDA_BASE="/opt/corda"
ENV CORDAPPS_FOLDER="/opt/corda/cordapps"
ENV PERSISTENCE_FOLDER="/opt/corda/persistence"
ENV CERTIFICATES_FOLDER="/opt/corda/certificates"
ENV DRIVERS_FOLDER="/opt/corda/drivers"
ENV CONFIG_FOLDER="/etc/corda"

ENV MY_P2P_PORT=10200
ENV MY_RPC_PORT=10201
ENV MY_RPC_ADMIN_PORT=10202

RUN chown -R corda:corda /opt/corda
RUN chown -R corda:corda /etc/corda

##CORDAPPS FOLDER
VOLUME ["/opt/corda/cordapps"]
##PERSISTENCE FOLDER
VOLUME ["/opt/corda/persistence"]
##CERTS FOLDER
VOLUME ["/opt/corda/certificates"]
##OPTIONAL JDBC DRIVERS FOLDER
VOLUME ["/opt/corda/drivers"]
##LOG FOLDER
VOLUME ["/opt/corda/logs"]
##ADDITIONAL NODE INFOS FOLDER
VOLUME ["/opt/corda/additional-node-infos"]
##CONFIG LOCATION
VOLUME ["/etc/corda"]


##DB MIGRATION JAR
ADD --chown=corda:corda database-manager.jar /opt/corda/bin/database-manager.jar
##CONFIG MANIPULATOR JAR
ADD --chown=corda:corda config-exporter.jar /opt/corda/config-exporter.jar
##CONFIG GENERATOR SHELL SCRIPT
ADD --chown=corda:corda generate-config.sh /opt/corda/bin/config-generator
##DB MIGRATOR RUN SCRIPT
ADD --chown=corda:corda db-migrate-create-jars.sh /opt/corda/bin/db-migrate-create-jars
##DB MIGRATOR RUN SCRIPT
ADD --chown=corda:corda db-migrate-execute-migration.sh /opt/corda/bin/db-migrate-execute-migration
##BASE CONFIG FOR GENERATOR
ADD --chown=corda:corda starting-node.conf /opt/corda/starting-node.conf
##SET EXECUTABLE PERMISSIONS
RUN chmod +x /opt/corda/bin/config-generator /opt/corda/bin/db-migrate-create-jars /opt/corda/bin/db-migrate-execute-migration

ENV PATH=$PATH:/opt/corda/bin

USER "corda"
CMD ["config-generator"]