FROM amazonlinux:2
RUN amazon-linux-extras enable corretto8
RUN yum -y install java-1.8.0-amazon-corretto-devel && yum install shadow-utils.x86_64 -y && yum clean all
# Create dirs
RUN mkdir -p /opt/corda/bin && \
    mkdir -p /etc/corda && \
    mkdir -p /opt/corda/certificates

# Create corda user
RUN groupadd corda && \
    useradd corda -g corda -m -d /opt/corda

WORKDIR /opt/corda

ENV CORDA_BASE="/opt/corda"
ENV CONFIG_FOLDER="/etc/corda"

ENV MY_P2P_PORT=10200

RUN chown -R corda:corda /opt/corda  && \
    chown -R corda:corda /etc/corda

##CERTS FOLDER
VOLUME ["/opt/corda/certificates"]
##LOG FOLDER
VOLUME ["/opt/corda/logs"]
##CONFIG LOCATION
VOLUME ["/etc/corda"]

##CORDA JAR
ADD --chown=corda:corda corda-firewall.jar /opt/corda/bin/corda-firewall.jar

##CORDA RUN SCRIPT
ADD --chown=corda:corda run-firewall.sh /opt/corda/bin/run-firewall
##SET EXECUTABLE PERMISSIONS
RUN chmod +x /opt/corda/bin/run-firewall

ENV PATH=$PATH:/opt/corda/bin

EXPOSE $MY_P2P_PORT
EXPOSE $MY_RPC_PORT

USER "corda"
CMD ["run-firewall"]