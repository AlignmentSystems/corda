FROM ubuntu:18.04 as build_system

RUN apt-get update -y && apt-get install --no-install-recommends -y -q \
                         curl \
                         zip \
                         build-essential \
                         ca-certificates \
                         git mercurial bzr \
                         apt-transport-https \
                         ca-certificates \
                         curl \
               && rm -rf /var/lib/apt/lists/*

ENV GOVERSION 1.9
RUN mkdir /goroot && mkdir /gopath
RUN curl https://storage.googleapis.com/golang/go${GOVERSION}.linux-amd64.tar.gz \
           | tar xvzf - -C /goroot --strip-components=1

ENV GOPATH /gopath
ENV GOROOT /goroot
ENV PATH $GOROOT/bin:$GOPATH/bin:$PATH
RUN git clone https://github.com/arminc/clair-scanner.git /gopath/src/clair-scanner
RUN cd /gopath/src/clair-scanner && make && make ensure && make build && cp clair-scanner $GOROOT/bin/

FROM ubuntu:18.04 as run_system
COPY --from=build_system /gopath/src/clair-scanner/clair-scanner /usr/bin/clair-scanner
RUN chmod +x /usr/bin/clair-scanner