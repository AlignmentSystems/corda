<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet author="R3.Corda" id="refactor_request_status">
        <update tableName="certificate_signing_request">
            <column name="status" value="DONE"/>
            <where>status = 'SIGNED'</where>
        </update>
        <update tableName="certificate_signing_request_AUD">
            <column name="status" value="DONE"/>
            <where>status = 'SIGNED'</where>
        </update>
    </changeSet>
    <changeSet author="R3.Corda" id="refactor_modified_by">
        <addColumn tableName="certificate_signing_request">
            <column name="modified_by" type="NVARCHAR(512)"/>
        </addColumn>
        <addColumn tableName="certificate_signing_request_AUD">
            <column name="modified_by" type="NVARCHAR(512)"/>
        </addColumn>
        <update tableName="certificate_signing_request">
            <column name="modified_by" valueComputed="(select b.modified_by from CertificateSigningRequestEntity_modifiedBy b where b.CertificateSigningRequestEntity_request_id=request_id)"/>
        </update>
    </changeSet>
    <changeSet author="R3.Corda" id="refactor_modified_by_sql_azure" dbms="azure">
        <sql>
            UPDATE
                csr_a
            SET
                csr_a.modified_by = csr_mb_a.modified_by
            FROM
                certificate_signing_request_AUD AS csr_a
                INNER JOIN CertificateSigningRequestEntity_modifiedBy_AUD AS csr_mb_a
                    ON csr_a.rev = csr_mb_a.rev
            WHERE
                csr_mb_a.revtype = 0
        </sql>
    </changeSet>
    <changeSet author="R3.Corda" id="refactor_modified_by_sql_h2" dbms="h2">
        <sql>
            UPDATE
                certificate_signing_request_AUD as csr_a
            SET
                (csr_a.modified_by) = (SELECT csr_mb_a.modified_by
                    FROM
                        certificate_signing_request_AUD AS csr_a
                    INNER JOIN CertificateSigningRequestEntity_modifiedBy_AUD AS csr_mb_a
                        ON csr_a.rev = csr_mb_a.rev
                    WHERE
                        csr_mb_a.revtype = 0)
        </sql>
    </changeSet>
    <changeSet author="R3.Corda" id="refactor_modified_by_drops">
        <dropForeignKeyConstraint baseTableName="CertificateSigningRequestEntity_modifiedBy" constraintName="FKLFW2KLKDPLYDROVIBVEOMF9PU"/>
        <dropIndex indexName="FKLFW2KLKDPLYDROVIBVEOMF9PU_INDEX_C"
                   tableName="CertificateSigningRequestEntity_modifiedBy"/>
        <dropTable cascadeConstraints="true"
                   tableName="CertificateSigningRequestEntity_modifiedBy"/>
        <dropTable cascadeConstraints="true"
                   tableName="CertificateSigningRequestEntity_modifiedBy_AUD"/>
    </changeSet>
</databaseChangeLog>