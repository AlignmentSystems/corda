<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<!--
  ~ R3 Proprietary and Confidential
  ~
  ~ Copyright (c) 2018 R3 Limited.  All rights reserved.
  ~
  ~ The intellectual and technical concepts contained herein are proprietary to R3 and its suppliers and are protected by trade secret law.
  ~
  ~ Distribution of this file or any portion thereof via any medium without the express permission of R3 is strictly prohibited.
  -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet author="R3.Corda" id="1513267683777-1" dbms="mssql">
        <createSequence sequenceName="hibernate_sequence" minValue="1"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1513267683777-1.1" dbms="h2">
        <createSequence sequenceName="hibernate_sequence"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1513267683777-1.2" dbms="azure">
        <createSequence sequenceName="hibernate_sequence" minValue="1"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1513267683777-1.3" dbms="postgres">
        <createSequence sequenceName="hibernate_sequence" minValue="1"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1513267683777-1.4" dbms="oracle">
        <createSequence sequenceName="hibernate_sequence" minValue="1"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-2">
        <createTable tableName="cert_data">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="cert_path_bytes" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="cert_status" type="NVARCHAR(16)">
                <constraints nullable="false"/>
            </column>
            <column name="cert_signing_request" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="cert_serial_number" type="NUMERIC(28)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-3">
        <createTable tableName="cert_signing_request">
            <column name="request_id" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="legal_name" type="NVARCHAR(256)"/>
            <column name="modified_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="remark" type="NVARCHAR(256)"/>
            <column name="request_bytes" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="NVARCHAR(16)">
                <constraints nullable="false"/>
            </column>
            <column name="public_key_hash" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="private_network" type="NVARCHAR(64)"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-4">
        <createTable tableName="cert_signing_request_AUD">
            <column name="request_id" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="REV" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="REVTYPE" type="TINYINT"/>
            <column name="remark" type="NVARCHAR(256)"/>
            <column name="status" type="NVARCHAR(16)"/>
            <column name="modified_by" type="NVARCHAR(64)"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-5">
        <createTable tableName="network_map">
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="cert" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="serialized_network_map" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="signature" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="network_parameters" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-6">
        <createTable tableName="network_parameters">
            <column name="hash" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="cert" type="BLOB"/>
            <column name="created" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="parameters_bytes" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="signature" type="BLOB"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-7">
        <createTable tableName="node_info">
            <column name="node_info_hash" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="public_key_hash" type="NVARCHAR(64)"/>
            <column name="signed_node_info_bytes" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="cert_signing_request" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="is_current" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="published_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="accepted_network_parameters" type="NVARCHAR(64)"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-8">
        <createTable tableName="REVINFO">
            <column autoIncrement="true" name="REV" type="INT">
                <constraints primaryKey="true" primaryKeyName="PK__REVINFO__REV"/>
            </column>
            <column name="REVTSTMP" type="BIGINT"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-9">
        <addPrimaryKey columnNames="hash" constraintName="PK__NP__H" tableName="network_parameters"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-10">
        <addPrimaryKey columnNames="id" constraintName="PK__CD__ID" tableName="cert_data"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-11">
        <addPrimaryKey columnNames="request_id, rev" constraintName="PK__CSRA__RID"
                       tableName="cert_signing_request_AUD"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-12">
        <addPrimaryKey columnNames="node_info_hash" constraintName="PK__NI__NIH" tableName="node_info"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-13">
        <addPrimaryKey columnNames="version" constraintName="PK__NM__V" tableName="network_map"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-14">
        <addPrimaryKey columnNames="request_id" constraintName="PK__CSR__RID" tableName="cert_signing_request"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-15">
        <addUniqueConstraint columnNames="cert_signing_request" constraintName="UK_CD_CSR" tableName="cert_data"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-16">
        <addUniqueConstraint columnNames="cert_serial_number" constraintName="UK_CD_CSN" tableName="cert_data"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-19">
        <createIndex indexName="IDX__CSRA__REV" tableName="cert_signing_request_AUD">
            <column name="REV"/>
        </createIndex>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-20">
        <createIndex indexName="IDX__CSR__PKH" tableName="cert_signing_request">
            <column name="public_key_hash"/>
        </createIndex>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-21">
        <addForeignKeyConstraint baseColumnNames="REV" baseTableName="cert_signing_request_AUD"
                                 constraintName="FK__CSRA__REV"
                                 referencedColumnNames="REV" referencedTableName="REVINFO"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-22">
        <addForeignKeyConstraint baseColumnNames="cert_signing_request" baseTableName="node_info"
                                 constraintName="FK__NI__CSR"
                                 referencedColumnNames="request_id" referencedTableName="cert_signing_request"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-23">
        <addForeignKeyConstraint baseColumnNames="cert_signing_request" baseTableName="cert_data"
                                 constraintName="FK__CD__CSR"
                                 referencedColumnNames="request_id" referencedTableName="cert_signing_request"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-24">
        <createIndex indexName="IDX_NP_HASH" tableName="network_parameters">
            <column name="hash"/>
        </createIndex>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-25">
        <createTable tableName="cert_revocation_request">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="request_id" type="NVARCHAR(64)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cert_serial_number" type="NUMERIC(28)">
                <constraints nullable="false"/>
            </column>
            <column name="legal_name" type="NVARCHAR(256)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="NVARCHAR(16)">
                <constraints nullable="false"/>
            </column>
            <column name="reporter" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="remark" type="NVARCHAR(256)"/>
            <column name="revocation_reason" type="NVARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="cert_data" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-26">
        <createTable tableName="cert_revocation_request_AUD">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="rev" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="revtype" type="TINYINT"/>
            <column name="revocation_reason" type="NVARCHAR(32)"/>
            <column name="modified_at" type="TIMESTAMP"/>
            <column name="modified_by" type="NVARCHAR(64)"/>
            <column name="remark" type="NVARCHAR(256)"/>
            <column name="status" type="NVARCHAR(16)"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-27">
        <createTable tableName="cert_revocation_list">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="issuer" type="NVARCHAR(16)">
                <constraints nullable="false"/>
            </column>
            <column name="crl_bytes" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="signed_by" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-29">
        <addPrimaryKey columnNames="id" constraintName="PK__CRR" tableName="cert_revocation_request"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-30">
        <addPrimaryKey columnNames="id, rev" constraintName="PK__CRR_AUD" tableName="cert_revocation_request_AUD"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-31">
        <addPrimaryKey columnNames="id" constraintName="PK__CRL" tableName="cert_revocation_list"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-33">
        <addForeignKeyConstraint baseColumnNames="cert_data"
                                 baseTableName="cert_revocation_request"
                                 constraintName="FK__CRR__CD"
                                 referencedColumnNames="id"
                                 referencedTableName="cert_data"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-34">
        <addForeignKeyConstraint baseColumnNames="rev"
                                 baseTableName="cert_revocation_request_AUD"
                                 constraintName="FK__CRR_AUD__REVINFO"
                                 referencedColumnNames="rev"
                                 referencedTableName="REVINFO"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-35">
        <createIndex indexName="IDX__CRR_AUD" tableName="cert_revocation_request_AUD">
            <column name="rev"/>
        </createIndex>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-36">
        <createTable tableName="private_network">
            <column name="id" type="NVARCHAR(64)">
                <constraints primaryKey="true" primaryKeyName="PK__PRIV_NETWORK__ID" nullable="false"/>
            </column>
            <column name="name" type="NVARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-37">
        <addForeignKeyConstraint baseColumnNames="private_network" baseTableName="cert_signing_request"
                                 constraintName="FK__CSR__PN"
                                 referencedColumnNames="id" referencedTableName="private_network"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-38">
        <addForeignKeyConstraint baseColumnNames="network_parameters" baseTableName="network_map"
                                 constraintName="FK_NM_NP"
                                 referencedColumnNames="hash" referencedTableName="network_parameters"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-39">
        <createTable tableName="parameters_update">
            <column name="description" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="update_deadline" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="network_parameters" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="flag_day" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="id" constraintName="CONSTRAINT_PARAMUPKEY" tableName="parameters_update"/>
        <addForeignKeyConstraint baseTableName="parameters_update" baseColumnNames="network_parameters"
                                 constraintName="FK_PU_NP"
                                 referencedTableName="network_parameters" referencedColumnNames="hash"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-40">
        <addForeignKeyConstraint baseColumnNames="accepted_network_parameters" baseTableName="node_info"
                                 constraintName="FK__NI__NP"
                                 referencedColumnNames="hash" referencedTableName="network_parameters"/>
    </changeSet>
</databaseChangeLog>
