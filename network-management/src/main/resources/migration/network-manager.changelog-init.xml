<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<!--
  ~ R3 Proprietary and Confidential
  ~
  ~ Copyright (c) 2018 R3 Limited.  All rights reserved.
  ~
  ~ The intellectual and technical concepts contained herein are proprietary to R3 and its suppliers and are protected by trade secret law.
  ~
  ~ Distribution of this file or any portion thereof via any medium without the express permission of R3 is strictly prohibited.
  -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet author="R3.Corda" id="1513267683777-1" dbms="mssql">
        <createSequence sequenceName="hibernate_sequence" minValue="1"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1513267683777-1.2" dbms="azure">
        <createSequence sequenceName="hibernate_sequence" minValue="1"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1513267683777-1.3" dbms="postgres">
        <createSequence sequenceName="hibernate_sequence" minValue="1"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1513267683777-1.1" dbms="h2">
        <createSequence sequenceName="hibernate_sequence"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-2">
        <createTable tableName="certificate_data">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="certificate_path_bytes" type="BLOB"/>
            <column name="certificate_status" type="INT"/>
            <column name="certificate_signing_request" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="certificate_serial_number" type="NUMERIC(28)"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-3">
        <createTable tableName="certificate_signing_request">
            <column name="request_id" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="legal_name" type="NVARCHAR(256)"/>
            <column name="modified_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="remark" type="NVARCHAR(256)"/>
            <column name="request_bytes" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="NVARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="public_key_hash" type="NVARCHAR(64)"/>
            <column name="modified_by" type="NVARCHAR(512)"/>
            <column name="private_network" type="NVARCHAR(255)"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-4">
        <createTable tableName="certificate_signing_request_AUD">
            <column name="request_id" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="REV" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="REVTYPE" type="TINYINT"/>
            <column name="modified_at" type="TIMESTAMP"/>
            <column name="remark" type="NVARCHAR(256)"/>
            <column name="status" type="NVARCHAR(255)"/>
            <column name="modified_by" type="NVARCHAR(512)"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-5">
        <createTable tableName="network_map">
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="certificate" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="serialized_network_map" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="signature" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="network_parameters" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-6">
        <createTable tableName="network_parameters">
            <column name="hash" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="certificate" type="BLOB"/>
            <column name="created" type="TIMESTAMP"/>
            <column name="parameters_bytes" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="signature" type="BLOB"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-7">
        <createTable tableName="node_info">
            <column name="node_info_hash" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="signed_node_info_bytes" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="certificate_signing_request" type="NVARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="is_current" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="published_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-8">
        <createTable tableName="REVINFO">
            <column autoIncrement="true" name="REV" type="INT">
                <constraints primaryKey="true" primaryKeyName="PK_REVINFO_REV"/>
            </column>
            <column name="REVTSTMP" type="BIGINT"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-9">
        <addPrimaryKey columnNames="hash" constraintName="PK_NP_H" tableName="network_parameters"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-10">
        <addPrimaryKey columnNames="id" constraintName="PK_CD_ID" tableName="certificate_data"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-11">
        <addPrimaryKey columnNames="request_id, rev" constraintName="PK_CSRA_RID" tableName="certificate_signing_request_AUD"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-12">
        <addPrimaryKey columnNames="node_info_hash" constraintName="PK_NI_NIH" tableName="node_info"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-13">
        <addPrimaryKey columnNames="version" constraintName="PK_NM_V" tableName="network_map"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-14">
        <addPrimaryKey columnNames="request_id" constraintName="PK_CSR_RID" tableName="certificate_signing_request"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-15">
        <addUniqueConstraint columnNames="certificate_signing_request" constraintName="UK_CD_CSR" tableName="certificate_data"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-19">
        <createIndex indexName="IDX_CSRA_REV" tableName="certificate_signing_request_AUD">
            <column name="REV"/>
        </createIndex>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-20">
        <createIndex indexName="IDX_PUB_KEY_HASH" tableName="certificate_signing_request">
            <column name="public_key_hash"/>
        </createIndex>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-21">
        <addForeignKeyConstraint baseColumnNames="REV" baseTableName="certificate_signing_request_AUD"
                                 constraintName="FK_CSRA_REV"
                                 referencedColumnNames="REV" referencedTableName="REVINFO"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-22">
        <addForeignKeyConstraint baseColumnNames="certificate_signing_request" baseTableName="node_info"
                                 constraintName="FK_NI_CSR"
                                 referencedColumnNames="request_id" referencedTableName="certificate_signing_request"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-23">
        <addForeignKeyConstraint baseColumnNames="certificate_signing_request" baseTableName="certificate_data"
                                 constraintName="FK_CD_CSR"
                                 referencedColumnNames="request_id" referencedTableName="certificate_signing_request"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-24">
        <createIndex indexName="IDX_NP_HASH" tableName="network_parameters">
            <column name="hash"/>
        </createIndex>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-25">
        <createTable tableName="certificate_revocation_request">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="request_id" type="NVARCHAR(256)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="certificate_serial_number" type="NUMERIC(28)">
                <constraints nullable="false"/>
            </column>
            <column name="legal_name" type="NVARCHAR(256)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="NVARCHAR(256)">
                <constraints nullable="false"/>
            </column>
            <column name="reporter" type="NVARCHAR(512)">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="NVARCHAR(512)">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="remark" type="NVARCHAR(256)"/>
            <column name="revocation_reason" type="NVARCHAR(256)">
                <constraints nullable="false"/>
            </column>
            <column name="certificate_data" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-26">
        <createTable tableName="certificate_revocation_request_AUD">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="rev" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="revtype" type="TINYINT"/>
            <column name="revocation_reason" type="NVARCHAR(256)"/>
            <column name="modified_at" type="TIMESTAMP"/>
            <column name="modified_by" type="NVARCHAR(256)"/>
            <column name="remark" type="NVARCHAR(256)"/>
            <column name="status" type="NVARCHAR(256)"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-27">
        <createTable tableName="certificate_revocation_list">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="issuer" type="NVARCHAR(256)">
                <constraints nullable="false"/>
            </column>
            <column name="crl_bytes" type="BLOB"/>
            <column name="modified_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="signed_by" type="NVARCHAR(512)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-28">
        <createTable tableName="certificate_revocation_list_AUD">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="rev" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="revtype" type="TINYINT"/>
            <column name="modified_at" type="TIMESTAMP"/>
            <column name="signed_by" type="NVARCHAR(512)"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-29">
        <addPrimaryKey columnNames="id" constraintName="certificate_revocation_request_pk" tableName="certificate_revocation_request"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-30">
        <addPrimaryKey columnNames="id, rev" constraintName="certificate_revocation_request_AUD_pk" tableName="certificate_revocation_request_AUD"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-31">
        <addPrimaryKey columnNames="id" constraintName="certificate_revocation_list_pk" tableName="certificate_revocation_list"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-32">
        <addPrimaryKey columnNames="id, rev" constraintName="certificate_revocation_list_AUD_pk" tableName="certificate_revocation_list_AUD"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-33">
        <addForeignKeyConstraint baseColumnNames="certificate_data"
                                 baseTableName="certificate_revocation_request"
                                 constraintName="cert_data__cert_rev_req_fk"
                                 referencedColumnNames="id"
                                 referencedTableName="certificate_data"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-34">
        <addForeignKeyConstraint baseColumnNames="rev"
                                 baseTableName="certificate_revocation_request_AUD"
                                 constraintName="cert_rev_req__REVINFO_AUD_fk"
                                 referencedColumnNames="rev"
                                 referencedTableName="REVINFO"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-35">
        <createIndex indexName="certificate_revocation_request_AUD_index" tableName="certificate_revocation_request_AUD">
            <column name="rev"/>
        </createIndex>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-36">
        <createTable tableName="private_network">
            <column name="id" type="NVARCHAR(255)">
                <constraints primaryKey="true" primaryKeyName="PK_PRIV_NETWORK_ID"/>
            </column>
            <column name="name" type="NVARCHAR(255)"/>
        </createTable>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-37">
        <addForeignKeyConstraint baseColumnNames="private_network" baseTableName="certificate_signing_request"
                                 constraintName="FK_CSR_PN"
                                 referencedColumnNames="id" referencedTableName="private_network"/>
    </changeSet>
    <changeSet author="R3.Corda" id="1520338500424-38">
        <addForeignKeyConstraint baseColumnNames="network_parameters" baseTableName="network_map"
                                 constraintName="FK_NM_NP"
                                 referencedColumnNames="hash" referencedTableName="network_parameters"/>
    </changeSet>
</databaseChangeLog>
