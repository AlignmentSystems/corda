<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet id="Certificate Revocation Request" author="R3.Corda">
        <createTable tableName="certificate_revocation_request">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="request_id" type="NVARCHAR(256)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="certificate_serial_number" type="NUMERIC(28)">
                <constraints nullable="false"/>
            </column>
            <column name="legal_name" type="NVARCHAR(256)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="reporter" type="NVARCHAR(512)">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="NVARCHAR(512)">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="remark" type="NVARCHAR(256)"/>
            <column name="revocation_reason" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="certificate_data" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="certificate_revocation_request_AUD">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="rev" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="revtype" type="TINYINT"/>
            <column name="revocation_reason" type="VARCHAR(255)"/>
            <column name="modified_at" type="TIMESTAMP"/>
            <column name="modified_by" type="NVARCHAR(256)"/>
            <column name="remark" type="NVARCHAR(256)"/>
            <column name="status" type="VARCHAR(255)"/>
        </createTable>
        <addColumn tableName="certificate_data">
            <column name="certificate_serial_number" type="NUMERIC(28)"/>
        </addColumn>
        <addPrimaryKey columnNames="id" constraintName="certificate_revocation_request_pk" tableName="certificate_revocation_request"/>
        <addPrimaryKey columnNames="id, rev" constraintName="certificate_revocation_request_AUD_pk" tableName="certificate_revocation_request_AUD"/>
        <createIndex indexName="certificate_revocation_request_AUD_index" tableName="certificate_revocation_request_AUD">
            <column name="rev"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="certificate_data"
                                 baseTableName="certificate_revocation_request"
                                 constraintName="cert_data__cert_rev_req_fk"
                                 referencedColumnNames="id"
                                 referencedTableName="certificate_data"/>
        <addForeignKeyConstraint baseColumnNames="rev"
                                 baseTableName="certificate_revocation_request_AUD"
                                 constraintName="cert_rev_req__REVINFO_AUD_fk"
                                 referencedColumnNames="rev"
                                 referencedTableName="REVINFO"/>
    </changeSet>
    <changeSet id="Certificate Serial Number" author="R3.Corda" runAlways="false" failOnError="true">
        <customChange class="com.r3.corda.networkmanage.common.persistence.migration.CertificateDataSerialNumber"/>
    </changeSet>
</databaseChangeLog>