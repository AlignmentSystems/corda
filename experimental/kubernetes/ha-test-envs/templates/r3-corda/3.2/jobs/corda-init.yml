apiVersion: batch/v1
kind: Job
metadata:
  name: {{ name }}-init
spec:
  template:
    spec:
      imagePullSecrets:
        - name: "registrysecret"
      initContainers:
      - name: {{ name }}-initial-registration
        image: {{ image }}
        args: ["--initial-registration", "--network-root-truststore", "certificates/network-root-truststore.jks", "--network-root-truststore-password", "password"]
        volumeMounts:
        - name: {{ name }}-configmap-volume
          mountPath: /opt/corda/node.conf
          subPath: node.conf
        - name: {{ name }}-empty-dir-certificates
          mountPath: /opt/corda/certificates
        - name: network-root-truststore-secret-volume
          mountPath: /opt/corda/certificates/network-root-truststore.jks
          subPath: network-root-truststore.jks

      - name: {{ name }}-just-generate-node-info
        image: {{ image }}
        args: ["--just-generate-node-info"]
        volumeMounts:
        - name: {{ name }}-configmap-volume
          mountPath: /opt/corda/node.conf
          subPath: node.conf
        - name: {{ name }}-empty-dir-certificates
          mountPath: /opt/corda/certificates

      containers:
      - name: upload-{{ name }}-certificates-secret
        image: haregistry.azurecr.io/kubectl:1.13.0
        args: ["kubectl create secret generic {{ name }}-certificates-secret --from-file=/opt/corda/certificates"]
        volumeMounts:
        - name: {{ name }}-empty-dir-certificates
          mountPath: /opt/corda/certificates
      
      volumes:
      - name: {{ name }}-configmap-volume
        configMap:
          name: {{ name }}-configmap
      - name: {{ name }}-empty-dir-certificates
        emptyDir: {}
      - name: network-root-truststore-secret-volume
        secret:
          secretName: network-root-truststore-secret
      - name: {{ name }}-empty-dir-node-info
        emptyDir: {}

      restartPolicy: Never

  backoffLimit: 0